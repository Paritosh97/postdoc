Bootstrap: docker
From: nvidia/cuda:11.8.0-devel-ubuntu22.04

%post
    apt-get update && DEBIAN_FRONTEND=noninteractive && apt-get install -y --no-install-recommends \
        python3 python3-pip python3-dev git curl ca-certificates build-essential libegl1-mesa-dev libgl1-mesa-dev libgles2-mesa-dev libglib2.0-0 libsm6 libxext6 libxrender1 python-is-python3 python3.10-dev python3-pip wget \
        && apt-get clean && rm -rf /var/lib/apt/lists/*

    update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1

    python3 -m pip install --upgrade pip setuptools==69.5.1 ninja

    export TORCH_CUDA_ARCH_LIST="6.0;6.1;7.0;7.5;8.0;8.6;8.9;9.0+PTX"
    export TCNN_CUDA_ARCHITECTURES="90;89;86;80;75;70;61;60"

    mkdir -p /workspace
    cd /workspace
    git clone https://github.com/GGGHSL/GraphDreamer.git
    cd GraphDreamer

    pip3 install --no-cache-dir -r requirements.txt
    pip3 install --no-cache-dir torch==2.7 torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu118
    pip3 install --no-cache-dir git+https://github.com/KAIR-BAIR/nerfacc.git@v0.5.2
    pip3 install --no-cache-dir git+https://github.com/NVlabs/tiny-cuda-nn.git#subdirectory=bindings/torch
    pip3 install --no-cache-dir typeguard libigl==2.5 numpy==1.24.4 opencv-python==4.7.0.72

    # --- TinyCUDA cache fix: symlink cache dir to /tmp ---
    mkdir -p /tmp/tinycudann_cache
    chmod 777 /tmp/tinycudann_cache
    mkdir -p /usr/local/lib/python3.10/dist-packages/tinycudann/rtc
    rm -rf /usr/local/lib/python3.10/dist-packages/tinycudann/rtc/cache
    ln -s /tmp/tinycudann_cache /usr/local/lib/python3.10/dist-packages/tinycudann/rtc/cache

%environment
    export TORCH_CUDA_ARCH_LIST="6.0 6.1 7.0 7.5 8.0 8.6 8.9 9.0+PTX"
    export TCNN_CUDA_ARCHITECTURES="90;89;86;80;75;70;61;60"

    export CUDA_HOME=/usr/local/cuda
    export PATH=/usr/local/cuda/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export LIBRARY_PATH=${CUDA_HOME}/lib64/stubs:${LIBRARY_PATH}
    export SINGULARITY_WORKDIR=/workspace/GraphDreamer

%labels
    Author Paritosh97
    Version v1.0
    Description PyTorch + nerfacc + tiny-cuda-nn + GraphDreamer on CUDA 11.8

%runscript
    exec python "$@"
